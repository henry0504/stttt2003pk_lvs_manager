{% extends "index.html" %}
{% block body %}
<div>
  <div>
    <div>
        <ul>
          <li><a href="/lvsmanager/">LVS Manager</a> <span></span></li>
          <li><a href="/lvsmanager_deploy/?id={{ vipinstance.cluster_id }}">LVS Configuration</a> <span></span></li>
          <li>Edit Vip Instance</li>
        </ul>
    </div>
  </div>

  <div>
    <div id='lvsmanager_deploy_add_body'>
        <h4>VIP</h4>
        <hr>
        <form>
            <div>
              <label for="vipinstance">VIP Instance</label>
              <div>
                <td><input id="vip_instance" type="text" name='vip_instance' check-type="required" value="{{ vipinstance.vip_instance }}"><span>must be uniq</span></td>
              </div>
            </div>
            <div>
              <label for="descript">service name</label>
              <div>
                <td><input id="descript" type="text" name='descript' value="{{ vipinstance.descript }}"></td>
              </div>
            </div>
            <div>
              <label for="owners">person in charge</label>
              <div>
                <td><input id="owners" type="text" name='owners' value="{{ vipinstance.owners }}"></td>
              </div>
            </div>
            <div>
              <label for="mailto">mail list warning</label>
              <div>
                <td><input style="width: 310px;" id="mailto" type="text" name='mailto' value="{{ vipinstance.mailto }}"><span>mail list split by comma</span></td>
              </div>
            </div>
            <div>
              <label for="vip_group">VIP group</label>
              <div>
                <td><input style="width: 310px;" id="vip_group" type="text" name='vip' value="{{ vipinstance.vip_group }}"><span>1.1.1.1:80,2.2.2.2:80</span></td>
              </div>
            </div>
            <div>
              <label for="protocol">protocol</label>
              <div>
                <select id="protocol" name='protocol'>
                    <option value='{{ vipinstance.protocol }}'>{{ vipinstance.protocol }}</option>
                    <option value='TCP'>TCP</option>
                    <option value='UDP'>UDP</option>
                </select>
              </div>
            </div>
            <div>
              <label for="delay_loop">monitor interval</label>
              <div>
                <td><input style="width: 40px;" id="delay_loop" type="text" name='delay_loop' value="{{ vipinstance.delay_loop }}"></td>
              </div>
            </div>
            <div>
              <label for="lb_algo">balance method</label>
              <div>
                <select id="lb_algo" name='lb_algo'>
                    <option value='{{ vipinstance.lb_algo }}'>{{ vipinstance.lb_algo }}</option>
                    <option value='wrr'>wrr</option>
                    <option value='rr'>rr</option>
                    <option value='lc'>lc</option>
                    <option value='wlc'>wlc</option>
                    <option value='lblc'>lblc</option>
                    <option value='sh'>sh</option>
                    <option value='dh'>dh</option>
                </select>
              </div>
            </div>
            <div>
              <label for="lb_kind">lvs type</label>
              <div>
                <select id="lb_kind" name='lb_kind'>
                    <option value='{{ vipinstance.lb_kind }}'>{{ vipinstance.lb_kind }}</option>
                    <option value='FNAT'>FNAT</option>
                    <option value='DR'>DR</option>
                    <option value='NAT'>NAT</option>
                    <option value='TUN'>TUN</option>
                </select>
              </div>
            </div>
            <div>
              <label for="persistence_timeout">persistence timeout</label>
              <div>
                <td><input style="width: 40px;" id="persistence_timeout" type="text" name='persistence_timeout' placeholder="persistence timeout" value='{{ vipinstance.persistence_timeout }}' ></td>
              </div>
            </div>
            <div>
              <label for="sync_proxy">syn flood defence</label>
              <div>
                <td><input id="sync_proxy" name='sync_proxy' type='checkbox' value='True' {% if vipinstance.sync_proxy %}checked="true"{% endif %}></td>
              </div>
            </div>
            <div>
              <label for="alpha">alpha</label>
              <div>
                <td><input id="alpha" name='alpha' type='checkbox' value='True' {% if vipinstance.alpha %}checked="true"{% endif %}><span>是否开启alpha模式,启动时默认rs是down状态，健康检查通过后才添加到lvs pool</span></td>
              </div>
            </div>
            <div>
              <label for="omega">omega</label>
              <div>
                <td><input id="omega" name='omega' type='checkbox' value='True' {% if vipinstance.omega %}checked="true"{% endif %}><span>是否开启omega模式，清楚rs时会执行相应的脚本(quorum_up)</span></td>
              </div>
            </div>
            <div>
              <label for="quorum">quorum</label>
              <div>
                <td><input style="width: 40px;" id="quorum" type="text" name='quorum' value='{{ vipinstance.quorum }}' ><span>service limit</span></td>
              </div>
            </div>
            <div>
              <label for="hysteresis">hysteresis</label>
              <div>
                <td><input style="width: 40px;" id="hysteresis" type="text" name='hysteresis' value='{{ vipinstance.hysteresis }}'><span>delay factor</span></td>
              </div>
            </div>
        </form>
        </br>
        <h4>RealServer组</h4>
        <hr>
        <button id="rs_add"><span></span>add real server</button>
        <table>
              <thead>
                <tr>
                  <th style="width: 10%">server manage IP</th>
                  <th style="width: 10%">service IP</th>
                  <th style="width: 10%">weight</th>
                  <th style="width: 40%">port list</th>
                  <th style="width: 10%">monitor</th>
                  <th>operation</th>
                </tr>
              </thead>
              <tbody id='rs_table_body'>
              {% for rs in vipinstance.rs %}
              <tr>
                <td>{{ rs.manager_ip }}</td>
                <td>{{ rs.server_ip }}</td>
                <td>{{ rs.weight }}</td>
                <td>{{ rs.port }}</td>
                <td>{{ rs.monitor.type }}</td>
                <td><a style="position: relative;left: 10px;" href="javascript:rs_edit({{ rs.i }})" ><span></span>edit</a></td>
              </tr>
              {% endfor %}
              </tbody>
        </table>
        <hr>
        <button style="position: relative;left: 770px;" id="lvs_deploy_add_submit" ><span></span>save</button>
        <a href="/lvsmanager_deploy/?id={{ vipinstance.cluster_id }}" style="position: relative;left: 770px;"><span></span>back</a>
    </div>


  <!--dialog edit rs -->
  <div id="dialog-form" title="new rs">
  <form>
  <fieldset>
    <div>
      <label for="manager_ip">manage IP</label>
      <div>
        <td><input id="manager_ip" type="text" name='manager_ip'><span>IP for login</span></td>
      </div>
    </div>
    <div>
      <label for="server_ip">service ip</label>
      <div>
        <td><input id="server_ip" type="text" name='server_ip'><span>IP for service</span></td>
      </div>
    </div>
    <div>
      <label for="weight">weight</label>
      <div>
        <td><input id="weight" type="text" name='weight'><span>real server weight<span></td>
      </div>
    </div>
    <div>
      <label for="rs_port">port list</label>
      <div>
        <td><input id="rs_port" type="text" name='rs_port'><span>port list split(',')</span></td>
      </div>
    </div>
    <div>
      <label for="monitor_type">monitor type</label>
      <div>
        <select id="monitor_type" name='monitor_type'>
            <option value='HTTP_GET'>HTTP_GET</option>
            <option value='TCP_CHECK'>TCP_CHECK</option>
            <option value='MISC_CHECK'>MISC_CHECK</option>
        </select>
      </div>
    </div>
    <div id="monitor_method">
        <div>
          <label for="path">path</label>
          <div>
            <td><input id="path" class="monitor_method_input" type="text" name='path'></td>
          </div>
        </div>
        <div>
          <label for="digest">digest</label>
          <div>
            <td><input id="digest" type="text" name='digest'></td>
          </div>
        </div>
        <div>
          <label for="connect_timeout">connection_timeout</label>
          <div>
            <td><input id="connect_timeout" class="monitor_method_input" type="text" name='connect_timeout'></td>
          </div>
        </div>
        <div>
          <label for="nb_get_retry">retry connection</label>
          <div>
            <td><input id="nb_get_retry" class="monitor_method_input" type="text" name='nb_get_retry'></td>
          </div>
        </div>
        <div>
          <label for="delay_before_retry">internal</label>
          <div>
            <td><input id="delay_before_retry" class="monitor_method_input" type="text" name='delay_before_retry'></td>
          </div>
        </div>
    </div>
  </fieldset>
  </form>
  </div>
  </div>

  <div id="dialog-form-edit" title="Edit Real Server Configuration">
    <form>
    <fieldset>
        <input id="edit_record_rs_num" type="text">
      <div>
        <label for="manager_ip">manage IP</label>
        <div>
          <td><input id="edit_manager_ip" type="text" name='manager_ip'><span>IP for login</span></td>
        </div>
    </div>
    <div>
        <label for="server_ip">service ip</label>
        <div>
          <td><input id="edit_server_ip" type="text" name='server_ip'><span>IP for service</span></td>
        </div>
    </div>
    <div>
        <label for="weight">weight</label>
        <div>
          <td><input id="edit_weight" type="text" name='weight'><span>real server weight</span></td>
        </div>
    </div>
    <div>
        <label for="rs_port">port list</label>
        <div>
          <td><input id="edit_rs_port" type="text" name='rs_port'><span>port list split(',')</span></td>
        </div>
    </div>
    <div>
        <label for="monitor_type">monitor type</label>
        <div>
          <select id="edit_monitor_type" name='monitor_type'>
            <option value='HTTP_GET'>HTTP_GET</option>
            <option value='TCP_CHECK'>TCP_CHECK</option>
            <option value='MISC_CHECK'>MISC_CHECK</option>
        </select>
        </div>
    </div>
    <div id="edit_monitor_method">
        <div>
          <label for="path">path</label>
          <div>
            <td><input id="path" type="text" name='path'></td>
          </div>
        </div>
        <div>
          <label for="digest">digest</label>
          <div>
            <td><input id="digest" type="text" name='digest'></td>
          </div>
        </div>
        <div>
          <label for="edit_connect_timeout">connection_timeout</label>
          <div>
            <td><input id="connect_timeout" type="text" name='connect_timeout'></td>
          </div>
        </div>
        <div>
          <label for="nb_get_retry">retry connection</label>
          <div>
            <td><input id="nb_get_retry" type="text" name='nb_get_retry'></td>
          </div>
        </div>
        <div>
          <label for="delay_before_retry">internal</label>
          <div>
            <td><input id="delay_before_retry" type="text" name='delay_before_retry'></td>
          </div>
        </div>
    </div>
    </fieldset>
    </form>
  </div>


  <!--dialog edit rs -->
</div>
<script type="text/javascript">
    //get the list 
    var rs_list = []
    $.ajax({
        type: 'GET',
        url: '/lvsmanager_deploy_get_rs_list/?id={{ vipinstance._id }}',
        cache: false,
        success: function(data){
                rs_list = JSON.parse(data);
                //rs_table();
        },
        error: function(XMLHttpRequest){
                alert("cannot get the rs_list of the {{ vipinstance._id }}" + XMLHttpRequest)
        },
    })
    //add rs dialog
    $("#rs_add").click(function(){
        $("#dialog-form").dialog("open");
    })

    $("#dialog-form").dialog({
        autoOpen: false,
        height: 600,
        width: 400,
        modal: true,
        buttons: {
            "save": function(){
                monitor_new = new Object;
                monitor = new Object;
                monitor_new['manager_ip'] = $("#manager_ip").val();
                monitor_new['server_ip'] = $("#server_ip").val();
                monitor_new['port'] = $("#rs_port").val();
                monitor_new['weight'] = $("#weight").val();
                monitor['type'] = $("#monitor_type").val();
                
                $(".monitor_method_input").each(function(){
                    var key = $(this).attr('id');
                    var value = $(this).val();
                    monitor[key] = value;
                })
                
                monitor_new['monitor'] = monitor;

                rs_list.push(monitor_new)
                rs_table();
                console.log(rs_list)
                $(this).dialog("close");
            },
            "cancel": function(){
                $(this).dialog("close");
            },
        },   
        
        close: function(){},
    });


    //render rs table
    var origin_rs_table_html = $("#rs_table_body").html(); 
    function rs_table(){
        var html = origin_rs_table_html;
        if (rs_list.length == 0){
            $("#rs_table_body").html(origin_rs_table_html)
        }
        else {
            for (rs in rs_list){
                _rs = rs_list[rs]
                html += '<tr><td>' + _rs['manager_ip'] + '</td><td>' + _rs['server_ip'] + '</td><td>' +
            _rs['weight'] + '</td><td>' + _rs['port'] + '</td><td>' +_rs['monitor']['type'] + '</td><td><a href="javascript:rs_remove(' + rs + ')" ><span></span>delete</a><a style="position: relative ; left: 10px;" href="javascript:rs_edit(' + rs + ')" ><span></span>edit</a></td></tr>'
                $("#rs_table_body").html(html)
            }
        }
    }

    //onselect monitor_type
    $("#monitor_type").change(function(){
        var monitor_type = $("#monitor_type").val();
        if (monitor_type == 'TCP_CHECK'){
            inputlist = {"connect_timeout":"connection timeout"};
        }
        else if (monitor_type == 'HTTP_GET'){
            inputlist = {"path":"path","digest":"digest","connect_timeout":"monitor time out","nb_get_retry":"times","delay_before_retry":"interval"};
        }
        else {
            inputlist = {"eav_path":"eav script","eav_timeout":"eav time out"};
        }
        _html = format_monitor_method_input(inputlist)
        $("#monitor_method").html(_html);
    });

    //add rs, html format the method imput
    function format_monitor_method_input(input_list){
        var html = ''
        for (i in input_list){
            html += '<div><label for="' + i + '">' + 
                input_list[i] + '</label> <div>' +
                '<td><input class="monitor_method_input" id="' + i + '" type="text" name="' + 
                    i + '"></td></div></div>'
        }
        return html
    }
    
    //remove the obj from rs_list
    function rs_remove(rs){
        rs_list.splice($.inArray(rs, rs_list), 1);
        rs_table();
    }

    //edit dialog
    var rs_num_now;
    function rs_edit(rs_num){
        $("#edit_record_rs_num").val(rs_num)
        $("#dialog-form-edit").dialog("open");
        rs_num_now = rs_num
        obj = rs_list[rs_num]
        obj_monitor = obj['monitor']

        $("#edit_manager_ip").val(obj['manager_ip'])
        $("#edit_server_ip").val(obj['server_ip'])
        $("#edit_rs_port").val(obj['port'])
        $("#edit_weight").val(obj['weight'])
        $("#edit_monitor_type").val(obj_monitor['type'])
    }
    
    $("#dialog-form-edit").dialog({
        autoOpen: false,
        height: 600,
        width: 400,
        modal: true,
        buttons:{
            "save": function(){
            },
            "cancle": function(){
            },
        },
        close: function(){},
    })

</script>

{% endblock %}
